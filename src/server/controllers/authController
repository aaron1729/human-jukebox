const spotifyApi = require('../utils/apiWrapper');
const { query } = require('../models/models');


const authController = {};


// store a boolean as res.locals.cookieMatch based on whether the cookies "spotifyId" and "access" exist and are a match in our db
authController.checkCookies = async (req, res, next) => {
    try {
        console.log('inside of authController.checkCookies')
        spotifyId = req.cookies.spotifyId;
        access = req.cookies.access;
        if (!spotifyId || !access) {
            res.locals.cookieMatch = false;
            return next();
        }
        const queryString = `SELECT handle, access FROM public.musicians WHERE spotify_id = '${spotifyId}'`;
        query(queryString).then(data => {
            console.log('after db query inside of authController.checkCookies, the data is:', data.rows)
            accessFromDb = data.rows[0].access;
            handleFromDb = data.rows[0].handle;
            if (access === accessFromDb) {
                res.locals.cookieMatch = true;
                res.locals.handle = handleFromDb;
            } else {
                res.locals.cookieMatch = false;
            }
            return next();
        });
    } catch {
        return next({
            log: 'error checking cookies',
            status: err.statusCode,
            message: {error: 'failed to check cookies'}
        });
    }
}


// this follows the above middleware. if cookies don't match, end the request/response cycle.
authController.endCycleIfCookiesUnmatched = (req, res, next) => {
    if (!res.locals.cookieMatch) {
        return res.status(200).send('sorry, cookies did not match')
    } else {
        return next()
    }
}


// get two tokens (long strings)
    // set them as cookies called 'access' and 'refresh'
    // also save them on res.locals
// when this function is triggered, req.query.code has been set to equal a massive string (sent by the spotify redirect).
authController.getTokens = async (req, res, next) => {
    console.log('inside of authController.getTokens middleware, and req.query.code is:', req.query.code);
    try {
        spotifyApi.authorizationCodeGrant(req.query.code)
        .then(data => {
            res.cookie('access', data.body.access_token).cookie('refresh', data.body.refresh_token);
            res.locals.access = data.body.access_token;
            res.locals.refresh = data.body.refresh_token;
            return next();
        })
    } catch {
        return next({
            log: 'error getting access and refresh tokens',
            status: err.statusCode,
            message: {error: 'failed to get access and refresh tokens'}
        });
    }
}


// using a musician's spotify access token (saved as res.locals.access), get their spotify id and set it as res.locals.spotifyId .
authController.getSpotifyId = async (req, res, next) => {
    try {
        spotifyApi.setAccessToken(res.locals.access);
        const userData = await spotifyApi.getMe();
        console.log('userData object is: ', userData);
        if (userData.statusCode === 200) {
            res.locals.spotifyId = userData.body.id;
            res.cookie('spotifyId', res.locals.spotifyId);
        }
        return next();
    } catch(err) {
        return next({
            log: 'error getting spotify id',
            status: err.statusCode,
            message: {error: 'failed to get spotify id. (perhaps you\'re in dev mode and the user isn\'t whitelisted in your spotify developer dashboard?)'}
        });
    }
}


// given a spotify id and an access token (saved res.locals.spotifyId and res.locals.access), check if the spotify id is in the database.
// if so, update its access token there.
// if not, create a new row in the database with some default values.
authController.spotifyIdToDb = async (req, res, next) => {
    try {
        const spotifyId = res.locals.spotifyId;
        const access = res.locals.access;
        const musicianInfoQueryString = `SELECT * FROM public.musicians WHERE spotify_id = '${spotifyId}'`;
        query(musicianInfoQueryString).then(data => {
            console.log('the array of musician data (which should have 0 or 1 elements) is:', data.rows)
            if (data.rows.length) {
                console.log('found musician in db');
                const updateAccessInDbQueryString = `UPDATE public.musicians SET access = '${access}' where spotify_id = '${spotifyId}'`;
                query(updateAccessInDbQueryString).then(data => {
                    if (data.rowCount === 1) {
                        return next();
                    } else {
                        return next({
                            log: 'error updating access token in db',
                            status: err.statusCode,
                            message: {error: 'failed to update access token in db'}
                        });
                    }
                })
            } else {
                const addMusicianToDbQueryString = `INSERT INTO public.musicians (display_name, bio, handle, spotify_id, access) VALUES ('temp display name', 'This is the bio of musician ${spotifyId}.', '${spotifyId}', '${spotifyId}', '${access}')`;
                query(addMusicianToDbQueryString).then(data => {
                    console.log('added musician to db, and returned data is:', data);
                    return next();
                })
            }
            return next();
        })
    } catch {
        return next({
            log: 'error syncing spotify id and access token with db',
            status: err.statusCode,
            message: {error: 'failed to sync spotify id and access token with db'}
        });
    }
}


// delete the cookies containing a musician's access and refresh tokens
authController.deleteCookies = (req, res, next) => {
    res.clearCookie('access').clearCookie('refresh').clearCookie('spotifyId');
    return next();
}


module.exports = authController;